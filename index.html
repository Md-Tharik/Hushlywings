<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Hushly Wings</title>

  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  
  <link rel="manifest" href="manifest.json">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <script src="https://quge5.com/88/tag.min.js" data-zone="212446" async data-cfasync="false"></script>



  <!-- ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
       ‚ïë  FIREBASE ‚Äî Replace with YOUR config                  ‚ïë
       ‚ïë  Firebase Console ‚Üí Project Settings ‚Üí Web App        ‚ïë
       ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù -->
  <script type="module">
    // Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(() => {
    console.log("Service Worker Registered");
  });
}

// ... your existing PWA button logic follows ...

    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
   import { getDatabase, ref, set, push, query, orderByChild, limitToLast, get }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // üî¥ REPLACE THIS ENTIRE BLOCK WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
  apiKey: "AIzaSyAw2i1LrIfnF2yYdXMIpolLA66Y4sYyGdk",
  authDomain: "hushly-wings.firebaseapp.com",
  databaseURL: "https://hushly-wings-default-rtdb.firebaseio.com",
  projectId: "hushly-wings",
  storageBucket: "hushly-wings.firebasestorage.app",
  messagingSenderId: "272017498391",
  appId: "1:272017498391:web:201d145cc04291dc295752",
  measurementId: "G-HBR2R4X5NF"
};

    const app      = initializeApp(firebaseConfig);
    const db       = getDatabase(app);
    const auth     = getAuth(app);
    const provider = new GoogleAuthProvider();

    window.fbSignInGoogle = async () => {
      try { const r = await signInWithPopup(auth, provider); return r.user; }
      catch(e) { console.warn('Login failed:',e); return null; }
    };
    window.fbSignOut = () => signOut(auth);
    window.fbOnAuth  = (cb) => onAuthStateChanged(auth, cb);

        window.fbSubmitScore = async (name, score) => {
      try {
        const user = auth.currentUser;
        if (!user) {
            alert("‚ùå Error: You are not signed in!");
            return;
        }

        const uid = user.uid;
        const scoreRef = ref(db, 'scores/' + uid);
        
        // 1. Get existing score
        // If this fails, the catch block below will trigger
        const snapshot = await get(scoreRef);
        
        // 2. Check if new score is higher
        if (!snapshot.exists() || score > snapshot.val().score) {
          await set(scoreRef, { 
            name: name.toUpperCase().slice(0, 12), 
            score: score, 
            ts: Date.now() 
          });
          alert("‚úÖ SUCCESS: Database Updated!"); // If you see this, it actually worked
        } else {
          alert("‚ö†Ô∏è Score too low: Your previous high score is better.");
        }
      } catch(e) { 
        // THIS IS THE IMPORTANT PART
        alert("‚ùå DATABASE ERROR: " + e.message); 
      }
    };


        window.fbGetLeaderboard = async () => {
      try {
        // Query the top 10 scores
        const q = query(ref(db, 'scores'), orderByChild('score'), limitToLast(10));
        const snap = await get(q);

        // DEBUG: Check if data exists
        if (!snap.exists()) {
           // If you see this, the database is actually empty (or path is wrong)
           alert("‚ö†Ô∏è Connected, but found 0 scores in database."); 
           return [];
        }

        const rows = [];
        snap.forEach(c => rows.push(c.val()));
        return rows.sort((a,b) => b.score - a.score);
        
      } catch(e) {
        // This will show you the real error (like Permission Denied)
        alert("‚ùå LEADERBOARD ERROR: " + e.message); 
        return [];
      }
    };

    // ‚îÄ‚îÄ COINS
    window.fbSaveCoins = async (coins) => {
      try {
        const user = auth.currentUser;
        if (!user) return;
        await set(ref(db, 'coins/' + user.uid), { coins, ts: Date.now() });
      } catch(e) { console.warn('fbSaveCoins error:', e); }
    };
    window.fbGetCoins = async () => {
      try {
        const user = auth.currentUser;
        if (!user) return 0;
        const snap = await get(ref(db, 'coins/' + user.uid));
        return snap.exists() ? (snap.val().coins || 0) : 0;
      } catch(e) { console.warn('fbGetCoins error:', e); return 0; }
    };

    // ‚îÄ‚îÄ UNLOCKED CHARACTERS
    window.fbSaveUnlocked = async (unlocked) => {
      try {
        const user = auth.currentUser;
        if (!user) return;
        await set(ref(db, 'unlocked/' + user.uid), { chars: JSON.stringify(unlocked), ts: Date.now() });
      } catch(e) { console.warn('fbSaveUnlocked error:', e); }
    };
    window.fbGetUnlocked = async () => {
      try {
        const user = auth.currentUser;
        if (!user) return [];
        const snap = await get(ref(db, 'unlocked/' + user.uid));
        return snap.exists() ? JSON.parse(snap.val().chars || '[]') : [];
      } catch(e) { console.warn('fbGetUnlocked error:', e); return []; }
    };

  </script>

  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

  <style>
    /* ‚ïê‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê‚ïê */
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
    html, body {
      width:100%; height:100%; overflow:hidden;
      background:#1a0533;
      font-family:'Fredoka One',cursive;
      -webkit-tap-highlight-color:transparent;
      touch-action:none;
    }

    /* ‚ïê‚ïê‚ïê‚ïê STARS ‚ïê‚ïê‚ïê‚ïê */
    .stars-bg { position:absolute; inset:0; overflow:hidden; pointer-events:none; }
    .star { position:absolute; border-radius:50%; background:#fff; animation:twinkle var(--dur,2s) infinite alternate; }
    @keyframes twinkle { from{opacity:.15} to{opacity:1} }

    /* ‚ïê‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê‚ïê */
    .screen {
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      pointer-events:auto; z-index:20;
      background:linear-gradient(160deg,#0f0c29,#302b63,#24243e);
      padding:20px; overflow:hidden;
    }
    .hidden { display:none !important; }

    /* ‚ïê‚ïê‚ïê‚ïê LOGO ‚ïê‚ïê‚ïê‚ïê */
    .logo-wrap { text-align:center; margin-bottom:6px; }
    .logo-title {
      font-size:clamp(2.6rem,10vw,5.5rem);
      color:#FFD700;
      text-shadow:4px 4px 0 #FF4500, 0 0 40px rgba(255,165,0,.8);
      -webkit-text-stroke:2px rgba(255,255,255,.2);
      letter-spacing:4px; line-height:1;
    }
    .logo-sub {
      color:rgba(255,255,255,.5); font-size:clamp(.58rem,2.2vw,.95rem);
      letter-spacing:5px; margin-top:4px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê BUTTONS ‚Äî base ‚ïê‚ïê‚ïê‚ïê */
    .menu-btn {
      border:none; cursor:pointer;
      font-family:'Fredoka One',cursive; letter-spacing:2px;
      transition:transform .12s, box-shadow .12s;
      position:relative; overflow:hidden;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
      display:block;
    }
    .menu-btn::after {
      content:''; position:absolute; inset:0;
      background:linear-gradient(180deg,rgba(255,255,255,.15) 0%,transparent 60%);
      pointer-events:none;
    }

    .btn-play {
      background:linear-gradient(135deg,#FF416C,#FF4B2B);
      color:#FFF; border-radius:50px;
      padding:clamp(12px,2.5vh,18px) clamp(36px,10vw,60px);
      font-size:clamp(1.15rem,4vw,1.8rem); margin:8px auto;
      box-shadow:0 7px 0 #8B0000,0 0 28px rgba(255,65,44,.5);
      width:clamp(200px,72vw,300px);
    }
    .btn-play:active { transform:translateY(4px); box-shadow:0 2px 0 #8B0000; }

    .btn-scores {
      background:linear-gradient(135deg,#7B2FBE,#5C17A0);
      color:#FFF; border-radius:50px;
      padding:clamp(10px,2vh,14px) clamp(28px,8vw,44px);
      font-size:clamp(1rem,3.5vw,1.4rem); margin:7px auto;
      box-shadow:0 6px 0 #300060,0 0 18px rgba(123,47,190,.5);
      width:clamp(180px,62vw,260px);
    }
    .btn-scores:active { transform:translateY(3px); box-shadow:0 2px 0 #300060; }

    .btn-settings {
      background:linear-gradient(135deg,#1565C0,#0D47A1);
      color:#FFF; border-radius:50px;
      padding:clamp(10px,2vh,14px) clamp(28px,8vw,44px);
      font-size:clamp(1rem,3.5vw,1.4rem); margin:7px auto;
      box-shadow:0 6px 0 #001a6b,0 0 18px rgba(21,101,192,.5);
      width:clamp(180px,62vw,260px);
    }
    .btn-settings:active { transform:translateY(3px); box-shadow:0 2px 0 #001a6b; }

    .btn-secondary {
      background:linear-gradient(135deg,#2c3e50,#3d5166);
      color:#CCC; border-radius:50px;
      padding:clamp(9px,1.8vh,12px) clamp(24px,7vw,36px);
      font-size:clamp(.9rem,2.8vw,1.1rem); margin:6px auto;
      box-shadow:0 5px 0 #111;
    }
    .btn-secondary:active { transform:translateY(3px); box-shadow:0 1px 0 #111; }

    .btn-gold {
      background:linear-gradient(135deg,#f7971e,#FFD700);
      color:#1a0533; border-radius:50px;
      padding:clamp(10px,2vh,14px) clamp(28px,7vw,44px);
      font-size:clamp(.95rem,3.2vw,1.3rem); margin:6px auto;
      box-shadow:0 6px 0 #7d5000;
    }
    .btn-gold:active { transform:translateY(3px); box-shadow:0 2px 0 #7d5000; }

    /* Google button */
    .btn-google {
      background:#fff; color:#3c4043; border-radius:50px;
      padding:clamp(10px,1.8vh,13px) clamp(18px,5vw,28px);
      font-size:clamp(.88rem,2.8vw,1.05rem); margin:6px auto;
      box-shadow:0 5px 0 #bbb,0 0 0 1px #ddd;
      display:flex; align-items:center; gap:10px; justify-content:center;
      width:clamp(200px,68vw,260px);
    }
    .btn-google:active { transform:translateY(3px); box-shadow:0 1px 0 #bbb; }
    .btn-google svg { width:20px; height:20px; flex-shrink:0; }

    /* ‚ïê‚ïê‚ïê‚ïê USER BAR ‚ïê‚ïê‚ïê‚ïê */
    #user-bar {
      position:absolute; top:12px; right:14px;
      display:flex; align-items:center; gap:8px; z-index:30;
    }
    #user-avatar {
      width:36px; height:36px; border-radius:50%;
      border:2px solid #FFD700; display:none;
      box-shadow:0 0 10px rgba(255,215,0,.5);
    }
    #user-name {
      color:#FFD700; font-size:.88rem; max-width:100px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:none;
    }
    #btn-signout {
      background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2);
      color:#fff; padding:5px 12px; font-size:.75rem; border-radius:30px;
      cursor:pointer; font-family:'Fredoka One',cursive; display:none;
    }

    /* ‚ïê‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê‚ïê */
    #game-ui { position:absolute; inset:0; pointer-events:none; z-index:10; }
    #score-display {
      position:absolute; top:16px; left:16px;
      color:#FFD700; font-size:clamp(14px,3.5vw,26px);
      background:rgba(0,0,0,.5); backdrop-filter:blur(6px);
      padding:7px 18px; border-radius:40px;
      border:2px solid rgba(255,215,0,.35);
      text-shadow:0 2px 8px rgba(0,0,0,.7);
    }
    #speed-display {
      position:absolute; top:16px; left:50%; transform:translateX(-50%);
      color:#FF6BFF; font-size:clamp(11px,2.8vw,18px);
      background:rgba(0,0,0,.45); backdrop-filter:blur(6px);
      padding:7px 16px; border-radius:40px;
      border:2px solid rgba(255,107,255,.35);
      white-space:nowrap; pointer-events:none;
    }
    #lift-warning {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      color:#FF4444; background:rgba(255,255,255,.94);
      padding:clamp(12px,3vh,20px) clamp(18px,5vw,30px);
      border:4px solid #FF4444; border-radius:20px;
      display:none; text-align:center; font-size:clamp(14px,4vw,22px);
      box-shadow:0 8px 30px rgba(255,0,0,.4);
      animation:warnPulse .5s infinite alternate; pointer-events:none;
    }
    @keyframes warnPulse {
      from{box-shadow:0 8px 30px rgba(255,0,0,.4)}
      to{box-shadow:0 8px 50px rgba(255,0,0,.9)}
    }

    /* Speed bar */
    #speed-bar-wrap {
      position:absolute; bottom:clamp(12px,3vh,20px); left:clamp(12px,3vw,20px);
      display:flex; flex-direction:column; gap:4px; z-index:11; pointer-events:none;
    }
    #speed-bar-label { color:rgba(255,255,255,.45); font-size:clamp(7px,1.8vw,11px); letter-spacing:2px; }
    #speed-bar-track {
      width:clamp(70px,18vw,130px); height:7px;
      background:rgba(255,255,255,.12); border-radius:10px; overflow:hidden;
    }
    #speed-bar-fill { height:100%; width:10%; border-radius:10px; background:linear-gradient(90deg,#00CFFF,#FF6BFF); transition:width .4s,background .4s; }

    /* ‚ïê‚ïê‚ïê‚ïê COUNTDOWN ‚ïê‚ïê‚ïê‚ïê */
    #countdown-screen {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); backdrop-filter:blur(4px); z-index:50; pointer-events:none;
    }
    #countdown-text {
      font-size:clamp(90px,22vw,200px); color:#FFF;
      text-shadow:0 0 40px #FF6BFF,0 10px 0 #9B00D3;
      animation:cBounce .5s infinite alternate;
    }
    @keyframes cBounce { from{transform:scale(1)} to{transform:scale(1.12)} }

    /* ‚ïê‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê‚ïê */
    #game-over-screen { background:linear-gradient(160deg,#200010,#6b0019,#200010) !important; }
    .crashed-title {
      font-size:clamp(2.4rem,9vw,4.5rem); color:#FF4444;
      text-shadow:4px 4px 0 #8B0000,0 0 60px rgba(255,68,68,.8);
      -webkit-text-stroke:2px rgba(255,255,255,.12);
      animation:shakeCrash .3s infinite;
    }
    @keyframes shakeCrash { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
    #final-score-go { color:#FFD700; font-size:clamp(1.2rem,4.5vw,2rem); margin:8px 0 14px; }
    #name-input-wrap { margin:8px 0; }
    #player-name-input {
      font-family:'Fredoka One',cursive;
      font-size:clamp(.95rem,3.5vw,1.4rem); padding:11px 18px;
      border-radius:30px; border:3px solid #FF4444;
      background:rgba(255,255,255,.1); color:#FFF;
      text-align:center; letter-spacing:4px; text-transform:uppercase;
      outline:none; width:clamp(190px,70vw,280px);
    }
    #player-name-input::placeholder { color:rgba(255,255,255,.3); }

    /* ‚ïê‚ïê‚ïê‚ïê SCORES SCREEN ‚ïê‚ïê‚ïê‚ïê */
    #scores-screen { background:linear-gradient(160deg,#0f0c29,#302b63,#24243e) !important; }
    .scores-title {
      font-size:clamp(1.7rem,6vw,3rem); color:#FFD700;
      text-shadow:3px 3px 0 #FF4500,0 0 28px rgba(255,165,0,.6); margin-bottom:16px;
    }
    #leaderboard-list {
      width:clamp(270px,88vw,400px); max-height:clamp(220px,42vh,380px);
      overflow-y:auto; scrollbar-width:thin; scrollbar-color:rgba(255,215,0,.3) transparent;
    }
    .lb-row {
      display:flex; justify-content:space-between; align-items:center;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
      padding:9px 16px; margin:5px 0; border-radius:12px;
      color:#FFF; font-size:clamp(.85rem,2.8vw,1.1rem);
    }
    .lb-row.top1{background:linear-gradient(90deg,rgba(255,215,0,.25),rgba(255,215,0,.04));border-color:#FFD700;color:#FFD700;}
    .lb-row.top2{background:linear-gradient(90deg,rgba(192,192,192,.2),transparent);border-color:#C0C0C0;color:#DDD;}
    .lb-row.top3{background:linear-gradient(90deg,rgba(205,127,50,.2),transparent);border-color:#CD7F32;color:#E8B87B;}
    .lb-rank{font-size:1.1rem;width:32px;}
    .lb-name{flex:1;padding:0 8px;}
    .lb-score{color:#FFD700;}
    #lb-loading{color:rgba(255,255,255,.5);font-size:1rem;padding:22px;text-align:center;}

    /* ‚ïê‚ïê‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê‚ïê‚ïê */
    #settings-screen { background:linear-gradient(160deg,#0f0c29,#1a2a50,#0f2040) !important; }
    .settings-title {
      font-size:clamp(1.6rem,5.5vw,2.8rem); color:#00CFFF;
      text-shadow:3px 3px 0 #005577,0 0 28px rgba(0,207,255,.5); margin-bottom:16px;
    }
    .setting-card {
      background:rgba(255,255,255,.07); border:2px solid rgba(255,255,255,.12);
      border-radius:18px; padding:clamp(14px,3vh,20px) clamp(16px,4vw,24px); margin:8px 0;
      width:clamp(270px,85vw,400px); backdrop-filter:blur(8px);
    }
    .setting-label { color:#FFF; font-size:clamp(.9rem,3vw,1.15rem); margin-bottom:12px; text-align:center; opacity:.85; }
    .toggle-row { display:flex; gap:8px; justify-content:center; }
    .toggle-btn {
      flex:1; padding:clamp(10px,2vh,14px) 8px; border-radius:12px;
      border:2px solid transparent; font-family:'Fredoka One',cursive;
      font-size:clamp(.8rem,2.5vw,1rem); cursor:pointer;
      transition:all .2s; text-align:center; color:#FFF;
      background:rgba(255,255,255,.08); touch-action:manipulation;
    }
    .toggle-btn.active {
      background:linear-gradient(135deg,#00CFFF,#0080FF);
      border-color:#00CFFF; box-shadow:0 4px 20px rgba(0,207,255,.4);
    }
    .setting-note { color:rgba(255,255,255,.38); font-size:.72rem; text-align:center; margin-top:8px; letter-spacing:1px; }

    /* ‚ïê‚ïê‚ïê‚ïê CAMERA + HAND DOT ‚ïê‚ïê‚ïê‚ïê */
    #input_video {
      position:absolute;
      bottom:clamp(12px,2.5vh,20px); right:clamp(12px,2.5vw,20px);
      width:clamp(100px,25vw,200px); height:clamp(75px,19vw,150px);
      transform:scaleX(-1); border:3px solid rgba(255,255,255,.22);
      border-radius:14px; z-index:5; background:#000;
      box-shadow:0 6px 20px rgba(0,0,0,.5); transition:opacity .3s;
    }
    #input_video.cam-hidden { opacity:0; pointer-events:none; }
    #cam-label {
      position:absolute;
      right:clamp(12px,2.5vw,20px);
      bottom:calc(clamp(75px,19vw,150px) + clamp(12px,2.5vh,20px) + 6px);
      color:rgba(255,255,255,.5); font-size:clamp(7px,1.8vw,11px); letter-spacing:2px;
      z-index:6; text-align:center; width:clamp(100px,25vw,200px);
      transition:opacity .3s;
    }
    #cam-label.cam-hidden { opacity:0; }
    #hand-dot {
      position:absolute; width:18px; height:18px;
      background:radial-gradient(circle,#00FFFF,#0080FF);
      border-radius:50%; z-index:15; pointer-events:none; display:none;
      box-shadow:0 0 12px #00FFFF,0 0 24px rgba(0,255,255,.5);
      transform:translate(-50%,-50%);
    }

    /* ‚ïê‚ïê‚ïê‚ïê VIRTUAL JOYSTICK ‚ïê‚ïê‚ïê‚ïê */
    #joystick-zone {
      position:absolute; inset:0; z-index:8;
      pointer-events:auto; display:none;
    }
    #joystick-outer {
      position:absolute;
      width:clamp(100px,26vw,160px); height:clamp(100px,26vw,160px);
      border-radius:50%;
      background:rgba(255,255,255,.07); border:3px solid rgba(255,255,255,.18);
      backdrop-filter:blur(4px);
      left:50%; bottom:clamp(28px,8vh,70px); transform:translateX(-50%);
      box-shadow:0 0 30px rgba(0,207,255,.12);
    }
    #joystick-inner {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:clamp(40px,10vw,64px); height:clamp(40px,10vw,64px);
      border-radius:50%;
      background:radial-gradient(circle,#00CFFF,#0050AA);
      border:2px solid rgba(255,255,255,.3);
      box-shadow:0 0 18px rgba(0,207,255,.5); pointer-events:none;
    }
    #joy-arrows {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; opacity:.2; font-size:clamp(8px,2vw,13px); color:#fff;
    }
    .ja { position:absolute; }
    .ja-u{top:5px;left:50%;transform:translateX(-50%)}
    .ja-d{bottom:5px;left:50%;transform:translateX(-50%)}
    .ja-l{left:5px;top:50%;transform:translateY(-50%)}
    .ja-r{right:5px;top:50%;transform:translateY(-50%)}

    /* ‚ïê‚ïê‚ïê‚ïê MEDIA QUERIES ‚ïê‚ïê‚ïê‚ïê */

    /* Very small phones ‚â§360px */
    @media (max-width:360px) {
      .logo-title { font-size:2.2rem; letter-spacing:1px; }
      .logo-sub   { display:none; }
      .btn-play   { width:88vw; font-size:1.1rem; padding:12px 20px; }
      .btn-scores,.btn-settings { width:78vw; font-size:.95rem; padding:10px 16px; }
      #menu-bug-canvas { width:46px!important; height:46px!important; margin:10px 0!important; }
      .setting-card { padding:12px 14px; }
      .toggle-btn { font-size:.75rem; padding:9px 4px; }
      #player-name-input { width:88vw; }
      #leaderboard-list { width:92vw; }
      #coin-display { top:48px; font-size:12px; padding:4px 10px; left:12px; }
    }

    /* Phones 361‚Äì480px */
    @media (min-width:361px) and (max-width:480px) {
      .btn-play   { width:82vw; }
      .btn-scores,.btn-settings { width:72vw; }
    }

    /* Landscape phones (short height) */
    @media (max-height:480px) and (orientation:landscape) {
      .screen { flex-direction:row; flex-wrap:wrap; justify-content:space-evenly; gap:6px; padding:8px 10px; }
      .logo-wrap { flex:0 0 auto; }
      .logo-title { font-size:1.9rem; }
      .logo-sub   { display:none; }
      #menu-bug-canvas { width:36px!important; height:36px!important; margin:4px 0!important; }
      .menu-btn { margin:3px auto; }
      .btn-play   { padding:10px 22px!important; font-size:1rem!important; width:auto!important; }
      .btn-scores,.btn-settings { padding:8px 18px!important; font-size:.88rem!important; width:auto!important; }
      #login-area { margin-top:4px!important; }
      .setting-card { margin:4px 0; padding:10px 12px; }
      #leaderboard-list { max-height:36vh; }
      #input_video { width:90px; height:68px; }
      #joystick-outer { bottom:8px; }
      #score-display,#speed-display { font-size:12px; padding:4px 10px; }
      #coin-display { font-size:11px; padding:3px 8px; top:36px; left:12px; }
      .crashed-title { font-size:2rem; }
      #final-score-go { font-size:1.1rem; margin:4px 0 10px; }
    }

    /* Tablets 481‚Äì768px */
    @media (min-width:481px) and (max-width:768px) {
      .logo-title { font-size:clamp(3rem,7.5vw,4.5rem); }
      .btn-play   { width:60vw; }
      .btn-scores,.btn-settings { width:52vw; }
      #leaderboard-list { width:min(390px,88vw); }
    }

    /* Desktop / large tablet ‚â•769px */
    @media (min-width:769px) {
      .btn-play   { width:280px; }
      .btn-scores,.btn-settings { width:240px; }
      .btn-google { width:250px; }
      #joystick-outer { width:160px; height:160px; }
      #joystick-inner { width:64px; height:64px; }
      .menu-btn:hover { transform:translateY(-3px); }
    }

    /* Very tall screens */
    @media (min-height:900px) {
      .logo-title { font-size:5.5rem; }
      #menu-bug-canvas { width:90px!important; height:90px!important; margin:20px 0!important; }
    }

    /* Notch safe area */
    @supports (padding:env(safe-area-inset-top)) {
      .screen {
        padding-top:  calc(20px + env(safe-area-inset-top));
        padding-left: calc(16px + env(safe-area-inset-left));
        padding-right:calc(16px + env(safe-area-inset-right));
      }
      #score-display { top:calc(16px + env(safe-area-inset-top)); left:calc(16px + env(safe-area-inset-left)); }
      #speed-display { top:calc(16px + env(safe-area-inset-top)); }
      #coin-display  { top:calc(55px + env(safe-area-inset-top)); left:calc(16px + env(safe-area-inset-left)); }
      #user-bar      { top:calc(12px + env(safe-area-inset-top)); right:calc(14px + env(safe-area-inset-right)); }
    }
    @keyframes camLostBounce { from{transform:scale(1) rotate(-5deg)} to{transform:scale(1.15) rotate(5deg)} }
    @keyframes handWave { from{transform:rotate(-20deg)} to{transform:rotate(20deg)} }

    .creator-credit {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    letter-spacing: 1px;
    z-index: 25; /* Ensures it stays above the menu stars but below overlays */
}

.creator-credit a {
    color: #FFD700; /* Matching your gold theme */
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.creator-credit a:hover {
    color: #FFF;
    border-bottom: 2px solid #FF4500;
    text-shadow: 0 0 10px #FF4500;
}
#btn-install-pwa {
    margin-top: 10px;
    box-shadow: 0 5px 0 #006400;
    width: clamp(200px, 68vw, 260px);
}
#btn-install-pwa:active {
    transform: translateY(3px);
    box-shadow: 0 1px 0 #006400;
}

/* ‚ïê‚ïê‚ïê‚ïê COIN HUD ‚ïê‚ïê‚ïê‚ïê */
#coin-display {
  position:absolute; top:55px; left:16px;
  color:#FFD700; font-size:clamp(13px,3vw,22px);
  background:rgba(0,0,0,.5); backdrop-filter:blur(6px);
  padding:5px 14px; border-radius:40px;
  border:2px solid rgba(255,215,0,.4);
  text-shadow:0 2px 8px rgba(0,0,0,.7);
  pointer-events:none; z-index:11;
}
/* Coin pickup popup */
#coin-popup {
  position:absolute; top:40%; left:50%; transform:translate(-50%,-50%);
  color:#FFD700; font-size:clamp(1.2rem,4vw,2rem);
  text-shadow:0 0 20px #FFD700;
  pointer-events:none; z-index:20; display:none;
  animation:coinPop .6s forwards;
}
@keyframes coinPop {
  0%{opacity:1;transform:translate(-50%,-50%) scale(1);}
  60%{opacity:1;transform:translate(-50%,-80%) scale(1.3);}
  100%{opacity:0;transform:translate(-50%,-100%) scale(1);}
}

/* ‚ïê‚ïê‚ïê‚ïê SHOP SCREEN ‚ïê‚ïê‚ïê‚ïê */
#shop-screen { background:linear-gradient(160deg,#0f0c29,#1a1045,#24243e) !important; }
.shop-title {
  font-size:clamp(1.7rem,6vw,3rem); color:#FFD700;
  text-shadow:3px 3px 0 #FF4500,0 0 28px rgba(255,165,0,.6); margin-bottom:6px;
}
.shop-coins-bar {
  color:#FFD700; font-size:clamp(1rem,3.5vw,1.4rem);
  background:rgba(0,0,0,.4); border:2px solid rgba(255,215,0,.4);
  padding:6px 20px; border-radius:30px; margin-bottom:14px;
}
.shop-grid {
  display:flex; flex-direction:column; gap:10px;
  width:clamp(270px,88vw,420px); max-height:clamp(250px,52vh,420px);
  overflow-y:auto; scrollbar-width:thin; scrollbar-color:rgba(255,215,0,.3) transparent;
}
.shop-card {
  display:flex; align-items:center; gap:14px;
  background:rgba(255,255,255,.07); border:2px solid rgba(255,255,255,.14);
  border-radius:16px; padding:12px 16px;
}
.shop-card.owned { border-color:rgba(0,255,100,.4); }
.shop-card.selected-char { border-color:#FFD700; background:rgba(255,215,0,.12); }
.shop-char-canvas { width:56px; height:56px; border-radius:10px; flex-shrink:0; background:rgba(0,0,0,.3); }
.shop-char-info { flex:1; }
.shop-char-name { color:#FFF; font-size:clamp(.9rem,2.8vw,1.1rem); }
.shop-char-desc { color:rgba(255,255,255,.45); font-size:.72rem; letter-spacing:1px; margin-top:3px; }
.shop-char-price { color:#FFD700; font-size:.85rem; margin-top:4px; }
.btn-buy {
  background:linear-gradient(135deg,#f7971e,#FFD700);
  color:#1a0533; border:none; border-radius:20px;
  padding:8px 16px; font-size:.85rem; font-family:'Fredoka One',cursive;
  cursor:pointer; flex-shrink:0; white-space:nowrap;
  box-shadow:0 4px 0 #7d5000; touch-action:manipulation;
}
.btn-buy:active { transform:translateY(2px); box-shadow:0 1px 0 #7d5000; }
.btn-buy.owned { background:linear-gradient(135deg,#2ecc71,#27ae60); color:#fff; box-shadow:0 4px 0 #1a7a40; }
.btn-buy.select-btn { background:linear-gradient(135deg,#7B2FBE,#5C17A0); color:#fff; box-shadow:0 4px 0 #300060; }
.btn-shop {
  background:linear-gradient(135deg,#f7971e,#FFD700);
  color:#1a0533; border-radius:50px;
  padding:clamp(10px,2vh,14px) clamp(28px,8vw,44px);
  font-size:clamp(1rem,3.5vw,1.4rem); margin:7px auto;
  box-shadow:0 6px 0 #7d5000;
  width:clamp(180px,62vw,260px);
}
.btn-shop:active { transform:translateY(3px); box-shadow:0 2px 0 #7d5000; }

/* ‚ïê‚ïê‚ïê‚ïê CAMERA RETRY ‚ïê‚ïê‚ïê‚ïê */
#cam-error-overlay {
  position:absolute; inset:0;
  background:rgba(0,0,0,.82); backdrop-filter:blur(6px);
  display:none; flex-direction:column; align-items:center; justify-content:center;
  z-index:60; text-align:center; padding:30px;
}
#cam-error-overlay .cam-err-icon { font-size:3.5rem; margin-bottom:10px; }
#cam-error-overlay p { color:#FFF; font-size:clamp(.9rem,3vw,1.2rem); margin-bottom:18px; font-family:'Fredoka One',cursive; letter-spacing:1px; line-height:1.5; }
#btn-cam-retry {
  background:linear-gradient(135deg,#00b09b,#00CFFF);
  color:#fff; border:none; border-radius:50px;
  padding:14px 36px; font-size:1.1rem; font-family:'Fredoka One',cursive;
  cursor:pointer; box-shadow:0 6px 0 #007a6b; letter-spacing:2px;
  touch-action:manipulation;
}
#btn-cam-retry:active { transform:translateY(3px); box-shadow:0 2px 0 #007a6b; }
#btn-cam-goto-menu {
  background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25);
  color:#fff; border-radius:50px; padding:10px 28px;
  font-size:.9rem; font-family:'Fredoka One',cursive;
  cursor:pointer; margin-top:10px; letter-spacing:1px;
  touch-action:manipulation;
}

    .logo-ladybug {
      font-size: clamp(2.8rem, 9vw, 5rem);
      margin-top: 8px;
      display: inline-block;
      animation: ladybugFloat 2.5s ease-in-out infinite;
      filter: drop-shadow(0 0 14px rgba(255, 60, 0, 0.7));
    }
    @keyframes ladybugFloat {
      0%, 100% { transform: translateY(0) rotate(-6deg); }
      50%       { transform: translateY(-10px) rotate(6deg); }
    }

  </style>
</head>
<body>

<!-- CAMERA FEED -->
<video id="input_video" autoplay playsinline muted></video>
<div id="cam-label">‚úã HAND CAM</div>
<div id="hand-dot"></div>

<!-- JOYSTICK -->
<div id="joystick-zone">
  <div id="joystick-outer">
    <div id="joystick-inner"></div>
    <div id="joy-arrows">
      <span class="ja ja-u">‚ñ≤</span><span class="ja ja-d">‚ñº</span>
      <span class="ja ja-l">‚óÑ</span><span class="ja ja-r">‚ñ∫</span>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="game-ui">
  <div id="score-display">‚≠ê 0</div>
  <div id="coin-display">ü™ô 0</div>
  <div id="speed-display">üöÄ LVL 1</div>
  <div id="lift-warning">‚ö†Ô∏è SHOW YOUR HAND!<br><small style="font-size:13px">Bug is falling!</small></div>
</div>
<div id="coin-popup">+1 ü™ô</div>
<div id="speed-bar-wrap">
  <div id="speed-bar-label">SPEED</div>
  <div id="speed-bar-track"><div id="speed-bar-fill"></div></div>
</div>

<!-- COUNTDOWN -->
<div id="countdown-screen" class="hidden">
  <div id="countdown-text">3</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="start-screen" class="screen">
  <div class="stars-bg" id="menu-stars"></div>

  <div id="user-bar">
    <img id="user-avatar" src="" alt="">
    <span id="user-name"></span>
    <button id="btn-signout">Sign out</button>
  </div>

  <div class="logo-wrap">
    <div class="logo-title">Hushly Wings</div>
    <div class="logo-sub">‚ú¶ HAND-TRACKING ADVENTURE ‚ú¶</div>
    <div class="logo-ladybug"></div>
  </div>
  <canvas id="menu-bug-canvas" width="70" height="70" style="margin:16px 0;image-rendering:pixelated;"></canvas>

  <button class="menu-btn btn-play"     id="btn-play">‚ñ∂ PLAY</button>
  <button class="menu-btn btn-scores"   id="btn-open-scores">üèÜ SCORES</button>
  <button class="menu-btn btn-shop"     id="btn-open-shop">üõí SHOP</button>
  <button class="menu-btn btn-settings" id="btn-open-settings">‚öôÔ∏è SETTINGS</button>

  <div id="login-area" style="margin-top:16px;">
    <button class="menu-btn btn-google" id="btn-google-login">
      <svg viewBox="0 0 48 48">
        <path fill="#FFC107" d="M43.6 20.1H42V20H24v8h11.3C33.6 32.9 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.1 7.9 3l5.7-5.7C34.2 6.5 29.4 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-9 20-20 0-1.3-.1-2.7-.4-3.9z"/>
        <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16 19 13 24 13c3.1 0 5.8 1.1 7.9 3l5.7-5.7C34.2 6.5 29.4 4 24 4 16.3 4 9.7 8.3 6.3 14.7z"/>
        <path fill="#4CAF50" d="M24 44c5.2 0 10-2 13.6-5.2l-6.3-5.3C29.5 35.1 26.9 36 24 36c-5.2 0-9.6-3.1-11.3-7.6l-6.6 5.1C9.5 39.6 16.3 44 24 44z"/>
        <path fill="#1976D2" d="M43.6 20.1H42V20H24v8h11.3c-.8 2.3-2.3 4.3-4.3 5.6l6.3 5.3C37.1 37.2 44 32 44 24c0-1.3-.1-2.7-.4-3.9z"/>
      </svg>
      Sign in with Google
    </button>
  </div>
  <p style="color:rgba(255,255,255,.22);font-size:.72rem;margin-top:18px;letter-spacing:2px;">SHOW YOUR HAND TO FLY</p>
  
  <div class="creator-credit">
    Made by <a href="https://www.instagram.com/tharik563" target="_blank">Tharik</a>
</div>
<button class="menu-btn btn-secondary" id="btn-install-pwa" style="display:none; background:linear-gradient(135deg,#00b09b,#96c93d); color:white; border-color:#fff;">
    üì≤ DOWNLOAD GAME
</button>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="shop-screen" class="screen hidden">
  <div class="stars-bg" id="shop-stars"></div>
  <div class="shop-title">üõí SHOP</div>
  <div class="shop-coins-bar">ü™ô <span id="shop-coin-count">0</span> Coins</div>
  <div class="shop-grid" id="shop-grid">
    <!-- Cards injected by JS -->
  </div>
  <button class="menu-btn btn-secondary" id="btn-shop-back" style="margin-top:18px">‚Üê BACK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAMERA ERROR OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="cam-error-overlay">
  <div class="cam-err-icon">üì∑</div>
  <p>Camera failed to start.<br>Please allow camera access and try again.</p>
  <button id="btn-cam-retry">üîÑ RETRY CAMERA</button>
  <button id="btn-cam-goto-menu">‚Ü© BACK TO MENU</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCORES SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scores-screen" class="screen hidden">
  <div class="stars-bg" id="scores-stars"></div>
  <div class="scores-title">üèÜ LEADERBOARD</div>
  <div id="leaderboard-list"><div id="lb-loading">Loading‚Ä¶</div></div>
  <button class="menu-btn btn-secondary" id="btn-scores-back" style="margin-top:20px">‚Üê BACK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="settings-screen" class="screen hidden">
  <div class="stars-bg" id="settings-stars"></div>
  <div class="settings-title">‚öôÔ∏è SETTINGS</div>

  <div class="setting-card">
    <div class="setting-label">üéÆ Control Mode</div>
    <div class="toggle-row">
      <button class="toggle-btn active" id="ctrl-hand"    onclick="setControl('hand')">‚úã Hand Tracking</button>
      <button class="toggle-btn"        id="ctrl-joy"     onclick="setControl('joystick')">üïπÔ∏è Joystick</button>
    </div>
    <div class="setting-note" id="ctrl-note">Requires camera permission</div>
  </div>

  <div class="setting-card">
    <div class="setting-label">üéµ Sound</div>
    <div class="toggle-row">
      <button class="toggle-btn active" id="snd-on"  onclick="setSound(true)">üîä ON</button>
      <button class="toggle-btn"        id="snd-off" onclick="setSound(false)">üîá OFF</button>
    </div>
  </div>

  <div class="setting-card">
    <div class="setting-label">üåà Difficulty Ramp</div>
    <div class="toggle-row">
      <button class="toggle-btn active" id="diff-normal" onclick="setDiffMode('normal')">üü¢ Normal</button>
      <button class="toggle-btn"        id="diff-hard"   onclick="setDiffMode('hard')">üî• Hard</button>
    </div>
    <div class="setting-note">Hard = 2√ó faster speed ramp</div>
  </div>

  <button class="menu-btn btn-secondary" id="btn-settings-back" style="margin-top:22px">‚Üê BACK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAMERA LOST (mid-game) POPUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="cam-lost-popup" style="
  display:none; position:fixed; inset:0; z-index:90;
  background:rgba(0,0,0,0.78); backdrop-filter:blur(8px);
  flex-direction:column; align-items:center; justify-content:center;
  text-align:center; padding:30px; font-family:'Fredoka One',cursive;
">
  <div style="font-size:4rem; margin-bottom:10px; animation:camLostBounce 1s infinite alternate;">üì∑</div>
  <div style="color:#FFD700; font-size:clamp(1.6rem,6vw,2.6rem); text-shadow:3px 3px 0 #FF4500; margin-bottom:8px;">Hand Lost!</div>
  <p style="color:rgba(255,255,255,.8); font-size:clamp(.9rem,3vw,1.15rem); margin-bottom:24px; line-height:1.6;">
    Your hand isn't visible.<br>Game is <span style="color:#00CFFF;">paused</span> ‚Äî show your hand to resume!
  </p>
  <div style="font-size:2.5rem; margin-bottom:18px; animation:handWave 1.2s infinite alternate;">‚úã</div>
  <button id="btn-cam-lost-resume" style="
    background:linear-gradient(135deg,#00b09b,#00CFFF); color:#fff; border:none;
    border-radius:50px; padding:14px 38px; font-size:1.1rem;
    font-family:'Fredoka One',cursive; cursor:pointer;
    box-shadow:0 6px 0 #007a6b; letter-spacing:2px;
    touch-action:manipulation; margin-bottom:12px; display:block;
  ">‚úã RESUME</button>
  <button id="btn-cam-lost-joystick" style="
    background:rgba(255,255,255,.1); border:2px solid rgba(255,255,255,.25);
    color:#fff; border-radius:50px; padding:11px 28px;
    font-size:.95rem; font-family:'Fredoka One',cursive;
    cursor:pointer; letter-spacing:1px; touch-action:manipulation; display:block;
  ">üïπÔ∏è SWITCH TO JOYSTICK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-over-screen" class="screen hidden">
  <div class="stars-bg" id="go-stars"></div>
  <div class="crashed-title">CRASHED!</div>
  <div id="final-score-go">SCORE: 0</div>
  <div id="name-input-wrap">
    <input id="player-name-input" type="text" maxlength="12" placeholder="YOUR NAME" spellcheck="false" autocomplete="off">
  </div>
  <button class="menu-btn btn-gold"      id="btn-submit-score">üì§ SUBMIT SCORE</button>
  <button class="menu-btn btn-play"      id="btn-watch-ad"
    style="font-size:clamp(.88rem,3vw,1.1rem);padding:clamp(10px,2vh,13px) clamp(22px,6vw,34px);">üé¨ REVIVE (AD)</button>
  <button class="menu-btn btn-secondary" id="btn-restart">‚Ü© MENU</button>
</div>
<div id="exit-modal" class="screen hidden" style="z-index: 100; background: rgba(0,0,0,0.85) !important;">
  <div class="setting-card" style="text-align: center; border-color: #FF4444; box-shadow: 0 0 30px rgba(255, 68, 68, 0.3);">
    <div class="settings-title" style="font-size: 2.2rem; margin-bottom: 10px; color: #FF4444; text-shadow: 0 0 20px #FF4444;">
      EXIT?
    </div>
    <p style="color: #FFF; margin-bottom: 24px; font-size: 1.1rem; line-height: 1.5;">
      Are you sure you want<br>to leave the game?
    </p>
    <div class="toggle-row" style="gap: 15px;">
      <button class="menu-btn btn-secondary" id="btn-exit-no" 
        style="margin:0; width:auto; padding: 12px 24px; font-size: 1rem;">
        NO, STAY
      </button>
      <button class="menu-btn" id="btn-exit-yes" 
        style="margin:0; width:auto; padding: 12px 24px; font-size: 1rem; background: #FF4444; color: white; border-radius: 50px; box-shadow: 0 4px 0 #8B0000;">
        YES, EXIT
      </button>
    </div>
  </div>
</div>

<script>
  let deferredPrompt;
const installBtn = document.getElementById('btn-install-pwa');

// 1. Listen for the install prompt
window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later.
    deferredPrompt = e;
    
    // Only show the button if NOT already installed
    if (!window.matchMedia('(display-mode: standalone)').matches) {
        installBtn.style.display = 'block';
    }
});

// 2. Handle the click event
installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    // Show the install prompt
    deferredPrompt.prompt();
    
    // Wait for the user to respond to the prompt
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
        installBtn.style.display = 'none'; // Hide button after acceptance
    }
    deferredPrompt = null;
});

// 3. Hide button if the app is launched as a PWA
window.addEventListener('appinstalled', (evt) => {
    console.log('PWA was installed');
    installBtn.style.display = 'none';
});

// 4. Final check: Hide if already in standalone mode (installed PWA)
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
    installBtn.style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STARS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
['menu-stars','scores-stars','settings-stars','go-stars','shop-stars'].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  for(let i=0;i<80;i++){
    const s=document.createElement('div'); s.className='star';
    const sz=Math.random()*3+1;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${(Math.random()*3+1).toFixed(1)}s;opacity:${Math.random()};`;
    el.appendChild(s);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let controlMode='hand', soundOn=true, diffMode='normal';

function setControl(m){
  controlMode=m;
  document.getElementById('ctrl-hand').classList.toggle('active',m==='hand');
  document.getElementById('ctrl-joy').classList.toggle('active', m==='joystick');
  document.getElementById('ctrl-note').innerText=m==='hand'?'Requires camera permission':'Touch & drag the joystick';
}
function setSound(on){
  soundOn=on;
  document.getElementById('snd-on').classList.toggle('active', on);
  document.getElementById('snd-off').classList.toggle('active',!on);
}
function setDiffMode(d){
  diffMode=d;
  document.getElementById('diff-normal').classList.toggle('active',d==='normal');
  document.getElementById('diff-hard').classList.toggle('active',  d==='hard');
}
function applyControlUI(){
  const isHand=controlMode==='hand';
  document.getElementById('input_video').classList.toggle('cam-hidden',!isHand);
  document.getElementById('cam-label').classList.toggle('cam-hidden',!isHand);
  document.getElementById('joystick-zone').style.display=isHand?'none':'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPRITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkSprite(fn,w,h){
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  fn(c.getContext('2d'),w,h);
  const t=new THREE.CanvasTexture(c);
  t.magFilter=THREE.NearestFilter; t.minFilter=THREE.NearestFilter;
  return t;
}

function drawBug(ctx,w,h,wp){
  ctx.clearRect(0,0,w,h);
  const cx=w/2,cy=h/2,wo=wp||0;
  // left wing
  ctx.save();ctx.translate(cx-8,cy-2);ctx.rotate(-0.15-wo*0.4);
  ctx.beginPath();ctx.ellipse(-10,-4,14,9,-0.3,0,Math.PI*2);ctx.fillStyle='#FF1744';ctx.fill();
  ctx.beginPath();ctx.ellipse(-12,-6,6,4,-0.3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.25)';ctx.fill();
  ctx.fillStyle='#1a0000';
  ctx.beginPath();ctx.arc(-8,-2,3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(-16,-5,2.5,0,Math.PI*2);ctx.fill();
  ctx.restore();
  // right wing
  ctx.save();ctx.translate(cx+8,cy-2);ctx.rotate(0.15+wo*0.4);
  ctx.beginPath();ctx.ellipse(10,-4,14,9,0.3,0,Math.PI*2);ctx.fillStyle='#FF1744';ctx.fill();
  ctx.beginPath();ctx.ellipse(12,-6,6,4,0.3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.25)';ctx.fill();
  ctx.fillStyle='#1a0000';
  ctx.beginPath();ctx.arc(8,-2,3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(16,-5,2.5,0,Math.PI*2);ctx.fill();
  ctx.restore();
  // body
  ctx.beginPath();ctx.ellipse(cx,cy+2,12,14,0,0,Math.PI*2);
  const bg=ctx.createRadialGradient(cx-3,cy-3,1,cx,cy,14);
  bg.addColorStop(0,'#FF4081');bg.addColorStop(.5,'#E00032');bg.addColorStop(1,'#8B0000');
  ctx.fillStyle=bg;ctx.fill();
  ctx.strokeStyle='#1a0000';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(cx,cy-13);ctx.lineTo(cx,cy+15);ctx.stroke();
  ctx.fillStyle='#1a0000';
  [[cx-5,cy-2,3.5],[cx+5,cy-2,3.5],[cx,cy+6,3],[cx-5,cy+7,2.5],[cx+5,cy+7,2.5]].forEach(([x,y,r])=>{
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
  });
  // head
  ctx.beginPath();ctx.ellipse(cx,cy-13,9,8,0,0,Math.PI*2);
  const hg=ctx.createRadialGradient(cx-2,cy-15,1,cx,cy-13,9);
  hg.addColorStop(0,'#444');hg.addColorStop(1,'#1a0000');ctx.fillStyle=hg;ctx.fill();
  ctx.fillStyle='#FFF';
  ctx.beginPath();ctx.arc(cx-4,cy-15,3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+4,cy-15,3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#000';
  ctx.beginPath();ctx.arc(cx-3.5,cy-15,1.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+4.5,cy-15,1.5,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#1a0000';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(cx-4,cy-20);ctx.lineTo(cx-8,cy-27);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx+4,cy-20);ctx.lineTo(cx+8,cy-27);ctx.stroke();
  ctx.fillStyle='#FF1744';
  ctx.beginPath();ctx.arc(cx-8,cy-27,2.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+8,cy-27,2.5,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#FF6699';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(cx,cy-12,4,0.1,Math.PI-0.1);ctx.stroke();
}

function drawJet(ctx,w,h,fr){
  ctx.clearRect(0,0,w,h);
  if(!fr){ctx.save();ctx.scale(-1,1);ctx.translate(-w,0);}
  const hh=h/2;
  const fl=ctx.createRadialGradient(8,hh,0,8,hh,12);
  fl.addColorStop(0,'rgba(255,200,0,.9)');fl.addColorStop(.5,'rgba(255,80,0,.6)');fl.addColorStop(1,'rgba(255,0,0,0)');
  ctx.fillStyle=fl;ctx.beginPath();ctx.ellipse(8,hh,12,6,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.moveTo(16,hh);ctx.quadraticCurveTo(w*.5,hh-8,w-10,hh-3);ctx.lineTo(w-10,hh+3);ctx.quadraticCurveTo(w*.5,hh+8,16,hh);
  const bg=ctx.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,'#FF6B6B');bg.addColorStop(.3,'#FF2020');bg.addColorStop(.7,'#CC0000');bg.addColorStop(1,'#880000');
  ctx.fillStyle=bg;ctx.fill();
  const wg=ctx.createLinearGradient(0,hh,0,h);wg.addColorStop(0,'#EE3030');wg.addColorStop(1,'#990000');
  ctx.beginPath();ctx.moveTo(w*.4,hh+2);ctx.lineTo(w*.2,h-4);ctx.lineTo(w*.6,hh+4);ctx.closePath();ctx.fillStyle=wg;ctx.fill();
  ctx.beginPath();ctx.moveTo(w*.4,hh-2);ctx.lineTo(w*.2,4);ctx.lineTo(w*.6,hh-4);ctx.closePath();ctx.fillStyle=wg;ctx.fill();
  ctx.beginPath();ctx.moveTo(22,hh-2);ctx.lineTo(14,6);ctx.lineTo(30,hh-2);ctx.closePath();ctx.fillStyle='#CC0000';ctx.fill();
  const cp=ctx.createRadialGradient(w-24,hh-3,1,w-22,hh-1,10);
  cp.addColorStop(0,'rgba(150,220,255,.9)');cp.addColorStop(.6,'rgba(50,150,220,.7)');cp.addColorStop(1,'rgba(0,50,100,.8)');
  ctx.beginPath();ctx.ellipse(w-22,hh-1,10,6,0,0,Math.PI*2);ctx.fillStyle=cp;ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.4)';ctx.lineWidth=1;ctx.beginPath();ctx.ellipse(w-22,hh-1,10,6,0,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(w-10,hh-3);ctx.lineTo(w+2,hh);ctx.lineTo(w-10,hh+3);ctx.closePath();ctx.fillStyle='#FF8888';ctx.fill();
  ctx.fillStyle='#FFD700';ctx.fillRect(w*.55,hh+5,14,3);
  ctx.beginPath();ctx.moveTo(w*.55+14,hh+5);ctx.lineTo(w*.55+18,hh+6.5);ctx.lineTo(w*.55+14,hh+8);ctx.closePath();ctx.fill();
  if(!fr)ctx.restore();
}

function drawBalloon(ctx,w,h,hue){
  ctx.clearRect(0,0,w,h);
  const cx=w/2,bR=22,bTop=12;
  for(let i=0;i<8;i++){
    const a=(i/8)*Math.PI*2,b=((i+1)/8)*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,bTop+bR);ctx.arc(cx,bTop+bR,bR,a-Math.PI/2,b-Math.PI/2);ctx.closePath();
    ctx.fillStyle=`hsl(${hue+i*45},90%,${i%2===0?55:70}%)`;ctx.fill();
  }
  const hi=ctx.createRadialGradient(cx-8,bTop+8,2,cx,bTop+bR,bR);
  hi.addColorStop(0,'rgba(255,255,255,.35)');hi.addColorStop(.5,'rgba(255,255,255,.08)');hi.addColorStop(1,'rgba(0,0,0,.15)');
  ctx.beginPath();ctx.arc(cx,bTop+bR,bR,0,Math.PI*2);ctx.fillStyle=hi;ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(cx,bTop+bR,bR,0,Math.PI*2);ctx.stroke();
  const bBot=bTop+bR*2,bkTop=h-22;
  ctx.strokeStyle='rgba(80,50,0,.8)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(cx-10,bBot+2);ctx.lineTo(cx-12,bkTop);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx+10,bBot+2);ctx.lineTo(cx+12,bkTop);ctx.stroke();
  const bk=ctx.createLinearGradient(cx-13,bkTop,cx+13,h);
  bk.addColorStop(0,'#C8860A');bk.addColorStop(.5,'#8B5E0A');bk.addColorStop(1,'#5a3b05');
  ctx.fillStyle=bk;ctx.beginPath();ctx.roundRect(cx-14,bkTop,28,18,4);ctx.fill();
  for(let x=-12;x<=12;x+=7){ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(cx+x,bkTop);ctx.lineTo(cx+x,bkTop+18);ctx.stroke();}
  ctx.strokeStyle='#FFD700';ctx.lineWidth=2;ctx.strokeRect(cx-14,bkTop,28,3);
  const fg=ctx.createRadialGradient(cx,bkTop-2,0,cx,bkTop-2,8);
  fg.addColorStop(0,'rgba(255,220,0,.9)');fg.addColorStop(.5,'rgba(255,100,0,.5)');fg.addColorStop(1,'rgba(255,0,0,0)');
  ctx.fillStyle=fg;ctx.beginPath();ctx.ellipse(cx,bkTop-2,8,10,0,0,Math.PI*2);ctx.fill();
}

function drawBird(ctx,w,h,wu){
  ctx.clearRect(0,0,w,h);
  const cx=w/2,cy=h/2,wy=wu?cy-8:cy+2;
  ctx.beginPath();ctx.ellipse(cx,wy,14,7,wu?-0.3:0.3,0,Math.PI*2);
  const wg=ctx.createLinearGradient(cx-14,wy-7,cx+14,wy+7);
  wg.addColorStop(0,'#00C853');wg.addColorStop(.5,'#00E676');wg.addColorStop(1,'#1B5E20');
  ctx.fillStyle=wg;ctx.fill();
  ctx.beginPath();ctx.moveTo(cx-14,cy);ctx.lineTo(cx-24,cy-4);ctx.lineTo(cx-20,cy+3);ctx.lineTo(cx-14,cy+2);ctx.closePath();ctx.fillStyle='#0097A7';ctx.fill();
  ctx.beginPath();ctx.ellipse(cx,cy,12,10,0,0,Math.PI*2);
  const bg=ctx.createRadialGradient(cx-3,cy-3,1,cx,cy,12);
  bg.addColorStop(0,'#FF6D00');bg.addColorStop(.5,'#E65100');bg.addColorStop(1,'#BF360C');
  ctx.fillStyle=bg;ctx.fill();
  ctx.beginPath();ctx.ellipse(cx+3,cy+1,6,7,.2,0,Math.PI*2);ctx.fillStyle='#FFD54F';ctx.fill();
  ctx.beginPath();ctx.ellipse(cx+10,cy-5,9,8,.3,0,Math.PI*2);
  const hg=ctx.createRadialGradient(cx+8,cy-7,1,cx+10,cy-5,9);
  hg.addColorStop(0,'#FF8F00');hg.addColorStop(1,'#E65100');ctx.fillStyle=hg;ctx.fill();
  ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(cx+14,cy-7,3.5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#000';ctx.beginPath();ctx.arc(cx+15,cy-7,2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.moveTo(cx+18,cy-5);ctx.lineTo(cx+24,cy-3);ctx.lineTo(cx+18,cy-1);ctx.closePath();ctx.fillStyle='#F9A825';ctx.fill();
  ctx.fillStyle='#FF1744';
  [[cx+9,cy-13,2.5],[cx+12,cy-15,2],[cx+7,cy-11,2]].forEach(([x,y,r])=>{ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();});
}

function drawStormCloud(ctx,w,h){
  ctx.clearRect(0,0,w,h);
  [[w/2,h/2+4,16],[w/2-14,h/2+8,12],[w/2+14,h/2+8,12],[w/2-6,h/2-4,14],[w/2+6,h/2-4,14]].forEach(([x,y,r])=>{
    const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.1,x,y,r);
    g.addColorStop(0,'#90A4AE');g.addColorStop(.6,'#546E7A');g.addColorStop(1,'#263238');
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
  });
  ctx.fillStyle='#FFD700';ctx.shadowColor='#FFD700';ctx.shadowBlur=8;
  ctx.beginPath();ctx.moveTo(w/2+2,h/2+4);ctx.lineTo(w/2-4,h/2+14);ctx.lineTo(w/2+1,h/2+14);
  ctx.lineTo(w/2-5,h/2+26);ctx.lineTo(w/2+6,h/2+12);ctx.lineTo(w/2+1,h/2+12);ctx.lineTo(w/2+8,h/2+4);
  ctx.closePath();ctx.fill();ctx.shadowBlur=0;
}

function drawCloud(ctx,w,h){
  ctx.clearRect(0,0,w,h);
  [[w/2,h/2+2,16],[w/2-16,h/2+6,11],[w/2+16,h/2+6,11],[w/2-7,h/2-6,13],[w/2+7,h/2-6,13]].forEach(([x,y,r])=>{
    const g=ctx.createRadialGradient(x,y-r*.3,r*.1,x,y,r);
    g.addColorStop(0,'rgba(255,255,255,1)');g.addColorStop(.7,'rgba(230,240,255,.9)');g.addColorStop(1,'rgba(200,220,255,.5)');
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
  });
}

const texBugA=mkSprite((c,w,h)=>drawBug(c,w,h,0),  80,80);
const texBugB=mkSprite((c,w,h)=>drawBug(c,w,h,1),  80,80);
const texJetR=mkSprite((c,w,h)=>drawJet(c,w,h,true), 90,48);
const texJetL=mkSprite((c,w,h)=>drawJet(c,w,h,false),90,48);
const texBalR=mkSprite((c,w,h)=>drawBalloon(c,w,h,0),  72,90);
const texBalG=mkSprite((c,w,h)=>drawBalloon(c,w,h,120),72,90);
const texBalB=mkSprite((c,w,h)=>drawBalloon(c,w,h,200),72,90);
const texBirdA=mkSprite((c,w,h)=>drawBird(c,w,h,true), 72,48);
const texBirdB=mkSprite((c,w,h)=>drawBird(c,w,h,false),72,48);
const texStorm=mkSprite((c,w,h)=>drawStormCloud(c,w,h),64,60);
const texCloud=mkSprite((c,w,h)=>drawCloud(c,w,h),     80,52);
const balTexes=[texBalR,texBalG,texBalB];

// ‚îÄ‚îÄ DRAGONFLY SPRITE ‚îÄ‚îÄ
function drawDragonfly(ctx,w,h,phase){
  ctx.clearRect(0,0,w,h);
  const cx=w/2,cy=h/2,wf=phase||0;
  // body
  ctx.save();
  const bg=ctx.createLinearGradient(cx,cy-16,cx,cy+18);
  bg.addColorStop(0,'#00E676');bg.addColorStop(.4,'#00BFA5');bg.addColorStop(1,'#1A237E');
  ctx.beginPath();ctx.ellipse(cx,cy,5,18,0,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();
  // segments
  for(let i=0;i<4;i++){
    ctx.beginPath();ctx.arc(cx,cy-6+i*7,4.5-i*.3,0,Math.PI*2);
    ctx.fillStyle=i%2===0?'#00E676':'#00BCD4';ctx.fill();
  }
  ctx.restore();
  // wings
  const wing=(ox,oy,flip,a)=>{
    ctx.save();ctx.translate(cx+ox,cy+oy);ctx.rotate(flip*(0.2+wf*0.3));
    const wg=ctx.createLinearGradient(-20,-12,20,12);
    wg.addColorStop(0,'rgba(100,255,218,.7)');wg.addColorStop(1,'rgba(0,150,136,.3)');
    ctx.beginPath();ctx.ellipse(flip*14,-8,18,8,a,0,Math.PI*2);ctx.fillStyle=wg;ctx.fill();
    ctx.strokeStyle='rgba(0,200,180,.4)';ctx.lineWidth=1;ctx.stroke();
    ctx.beginPath();ctx.ellipse(flip*12,4,14,6,a,0,Math.PI*2);ctx.fillStyle=wg;ctx.fill();ctx.stroke();
    ctx.restore();
  };
  wing(-4,-4,-1,-0.2);wing(4,-4,1,0.2);
  // head
  ctx.beginPath();ctx.arc(cx,cy-18,7,0,Math.PI*2);
  const hg=ctx.createRadialGradient(cx-2,cy-20,1,cx,cy-18,7);
  hg.addColorStop(0,'#76FF03');hg.addColorStop(1,'#1B5E20');
  ctx.fillStyle=hg;ctx.fill();
  ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(cx-3,cy-20,3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+3,cy-20,3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#000';ctx.beginPath();ctx.arc(cx-2.5,cy-20,1.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+3.5,cy-20,1.5,0,Math.PI*2);ctx.fill();
}

// ‚îÄ‚îÄ BUTTERFLY SPRITE ‚îÄ‚îÄ
function drawButterfly(ctx,w,h,phase){
  ctx.clearRect(0,0,w,h);
  const cx=w/2,cy=h/2,wf=phase||0;
  const wingUp=(ox,flip)=>{
    ctx.save();ctx.translate(cx+ox,cy-4);ctx.rotate(flip*(-0.1-wf*0.4));
    const wg=ctx.createRadialGradient(flip*10,-8,2,flip*10,-8,20);
    wg.addColorStop(0,'#FF6D00');wg.addColorStop(.4,'#FF9100');wg.addColorStop(1,'#E65100');
    ctx.beginPath();ctx.ellipse(flip*12,-10,20,12,-0.3*flip,0,Math.PI*2);ctx.fillStyle=wg;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1.5;ctx.stroke();
    // wing pattern dots
    ctx.fillStyle='rgba(255,255,255,.5)';
    [[flip*10,-14,2],[flip*18,-8,1.5],[flip*8,-6,1.5]].forEach(([x,y,r])=>{ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();});
    ctx.restore();
  };
  const wingLow=(ox,flip)=>{
    ctx.save();ctx.translate(cx+ox,cy+2);ctx.rotate(flip*(0.15+wf*0.35));
    const wg=ctx.createRadialGradient(flip*8,6,2,flip*8,6,14);
    wg.addColorStop(0,'#FF6D00');wg.addColorStop(1,'#BF360C');
    ctx.beginPath();ctx.ellipse(flip*10,8,14,9,0.2*flip,0,Math.PI*2);ctx.fillStyle=wg;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1.5;ctx.stroke();
    ctx.restore();
  };
  wingUp(-3,-1);wingUp(3,1);wingLow(-3,-1);wingLow(3,1);
  // body
  ctx.beginPath();ctx.ellipse(cx,cy,4,16,0,0,Math.PI*2);
  ctx.fillStyle='#212121';ctx.fill();
  // head
  ctx.beginPath();ctx.arc(cx,cy-16,5,0,Math.PI*2);ctx.fillStyle='#333';ctx.fill();
  ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(cx-2.5,cy-18,2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+2.5,cy-18,2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#000';ctx.beginPath();ctx.arc(cx-2.5,cy-18,1,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+2.5,cy-18,1,0,Math.PI*2);ctx.fill();
  // antennae
  ctx.strokeStyle='#333';ctx.lineWidth=1.2;
  ctx.beginPath();ctx.moveTo(cx-2,cy-20);ctx.quadraticCurveTo(cx-8,cy-28,cx-6,cy-32);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx+2,cy-20);ctx.quadraticCurveTo(cx+8,cy-28,cx+6,cy-32);ctx.stroke();
  ctx.fillStyle='#FF6D00';ctx.beginPath();ctx.arc(cx-6,cy-32,2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx+6,cy-32,2,0,Math.PI*2);ctx.fill();
}

// ‚îÄ‚îÄ COIN SPRITE ‚îÄ‚îÄ
function drawCoin(ctx,w,h){
  ctx.clearRect(0,0,w,h);
  const cx=w/2,cy=h/2;
  const g=ctx.createRadialGradient(cx-4,cy-4,2,cx,cy,12);
  g.addColorStop(0,'#FFE57F');g.addColorStop(.4,'#FFD700');g.addColorStop(1,'#B8860B');
  ctx.beginPath();ctx.arc(cx,cy,11,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1.5;ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,.45)';ctx.font='bold 11px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('$',cx,cy+1);
}

const texDflyA=mkSprite((c,w,h)=>drawDragonfly(c,w,h,0),80,80);
const texDflyB=mkSprite((c,w,h)=>drawDragonfly(c,w,h,1),80,80);
const texBtflyA=mkSprite((c,w,h)=>drawButterfly(c,w,h,0),80,80);
const texBtflyB=mkSprite((c,w,h)=>drawButterfly(c,w,h,1),80,80);
const texCoin=mkSprite((c,w,h)=>drawCoin(c,w,h),32,32);

// Menu bug preview
drawBug(document.getElementById('menu-bug-canvas').getContext('2d'),70,70,0.5);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
function playSfx(type){
  if(!soundOn)return;
  if(audioCtx.state==='suspended')audioCtx.resume();
  const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
  osc.connect(gain);gain.connect(audioCtx.destination);
  if(type==='flap'){
    osc.type='sine';osc.frequency.setValueAtTime(500,audioCtx.currentTime);osc.frequency.linearRampToValueAtTime(300,audioCtx.currentTime+.08);
    gain.gain.setValueAtTime(.04,audioCtx.currentTime);gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+.08);
    osc.start();osc.stop(audioCtx.currentTime+.08);
  }else if(type==='crash'){
    osc.type='sawtooth';osc.frequency.setValueAtTime(180,audioCtx.currentTime);osc.frequency.exponentialRampToValueAtTime(40,audioCtx.currentTime+.4);
    gain.gain.setValueAtTime(.12,audioCtx.currentTime);gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+.4);
    osc.start();osc.stop(audioCtx.currentTime+.4);
  }else if(type==='score'){
    osc.type='triangle';osc.frequency.setValueAtTime(600,audioCtx.currentTime);osc.frequency.linearRampToValueAtTime(900,audioCtx.currentTime+.15);
    gain.gain.setValueAtTime(.05,audioCtx.currentTime);gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+.15);
    osc.start();osc.stop(audioCtx.currentTime+.15);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THREE.JS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000);
camera.position.z=28;
const renderer=new THREE.WebGLRenderer({antialias:false,alpha:false});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.domElement.style.position = 'absolute';
renderer.domElement.style.top = '0';
renderer.domElement.style.left = '0';
renderer.domElement.style.zIndex = '0';
renderer.domElement.style.pointerEvents = 'none';
document.body.appendChild(renderer.domElement);

// Sky gradient BG
;(()=>{
  const bg=document.createElement('canvas');bg.width=2;bg.height=512;
  const bc=bg.getContext('2d'),gr=bc.createLinearGradient(0,0,0,512);
  gr.addColorStop(0,'#0a0020');gr.addColorStop(.3,'#1a0050');gr.addColorStop(.6,'#003080');gr.addColorStop(1,'#0077b6');
  bc.fillStyle=gr;bc.fillRect(0,0,2,512);
  const bt=new THREE.CanvasTexture(bg);
  const bm=new THREE.Mesh(new THREE.PlaneGeometry(200,200),new THREE.MeshBasicMaterial({map:bt,depthWrite:false}));
  bm.position.z=-30;scene.add(bm);
})();

const player=new THREE.Sprite(new THREE.SpriteMaterial({map:texBugA,transparent:true}));
player.scale.set(3.5,3.5,1);scene.add(player);

const tetherLine=new THREE.Line(
  new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(),new THREE.Vector3()]),
  new THREE.LineBasicMaterial({color:0x00FFFF,linewidth:2,transparent:true,opacity:.7})
);
scene.add(tetherLine);

const particles=[],bgClouds=[];
function spawnParticles(x,y,color){
  for(let i=0;i<12;i++){
    const geo=new THREE.PlaneGeometry(.3,.3);
    const mat=new THREE.MeshBasicMaterial({color,transparent:true,opacity:1});
    const m=new THREE.Mesh(geo,mat);m.position.set(x,y,1);scene.add(m);
    const a=Math.random()*Math.PI*2,sp=.1+Math.random()*.2;
    particles.push({mesh:m,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1});
  }
}
for(let i=0;i<18;i++){
  const s=new THREE.Sprite(new THREE.SpriteMaterial({map:texCloud,transparent:true,opacity:.5}));
  const sc=3+Math.random()*3;s.scale.set(sc*1.5,sc,1);
  s.position.set((Math.random()-.5)*60,(Math.random()-.5)*40,-8-Math.random()*6);
  scene.add(s);bgClouds.push({mesh:s,speed:.03+Math.random()*.06});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HAND TRACKING ‚Äî MVP, always here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const videoElement=document.getElementById('input_video');
const handDot=document.getElementById('hand-dot');
let targetPos=new THREE.Vector3(0,0,0),hasFinger=false;
const WORLD_W=34,WORLD_H=26;

const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1,modelComplexity:0,minDetectionConfidence:.5,minTrackingConfidence:.5});
hands.onResults(res=>{
  if(res.multiHandLandmarks&&res.multiHandLandmarks.length>0){
    hasFinger=true;
    const tip=res.multiHandLandmarks[0][8];
    targetPos.x=(1-tip.x-.5)*WORLD_W;
    targetPos.y=Math.max(-15,Math.min(14,-(tip.y-.5)*WORLD_H));
    handDot.style.display='block';
    handDot.style.left=(1-tip.x)*innerWidth+'px';
    handDot.style.top=tip.y*innerHeight+'px';
    document.getElementById('lift-warning').style.display='none';
    if(Math.random()>.9&&gameState==='PLAYING')playSfx('flap');
    // Auto-resume if game was paused due to lost hand
    if(gameState==='PAUSED') resumeFromCamLost();
  } else {
    hasFinger=false;handDot.style.display='none';
    if(gameState==='PLAYING'&&controlMode==='hand')
      document.getElementById('lift-warning').style.display='block';
  }
});
// Watchdog catches silent black-stream: stream opens but video never renders frames
let camFrameCount=0;
let camWatchdogTimer=null;

const cam=new Camera(videoElement,{
  onFrame:async()=>{
    // readyState>=3 (HAVE_FUTURE_DATA) + videoWidth>0 + not paused = truly rendering
    if(videoElement.readyState>=3&&videoElement.videoWidth>0&&!videoElement.paused){
      camFrameCount++;
      await hands.send({image:videoElement});
    }
  },
  width:320,height:240
});

function showCamError(){
  document.getElementById('cam-error-overlay').style.display='flex';
}

function startCamera(){
  document.getElementById('cam-error-overlay').style.display='none';
  camFrameCount=0;
  clearTimeout(camWatchdogTimer);
  cam.start().then(()=>{
    // 4s watchdog: if no frames arrive after stream opens the feed is silently black
    camWatchdogTimer=setTimeout(()=>{
      if(camFrameCount===0){
        console.warn('Cam watchdog: stream opened but 0 frames received.');
        showCamError();
      }
    },4000);
  }).catch(e=>{
    console.error('Cam start failed:',e);
    showCamError();
  });
}
startCamera();

document.getElementById('btn-cam-retry').addEventListener('click',()=>{
  startCamera();
});
document.getElementById('btn-cam-goto-menu').addEventListener('click',()=>{
  document.getElementById('cam-error-overlay').style.display='none';
  // Switch to joystick mode as fallback
  setControl('joystick');
  document.getElementById('start-screen').classList.remove('hidden');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIRTUAL JOYSTICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const joyOuter=document.getElementById('joystick-outer');
const joyInner=document.getElementById('joystick-inner');
let joyDX=0,joyDY=0;

function joyMove(tx,ty){
  const r=joyOuter.getBoundingClientRect();
  const ox=r.left+r.width/2,oy=r.top+r.height/2;
  let dx=tx-ox,dy=ty-oy;
  const d=Math.sqrt(dx*dx+dy*dy),maxR=r.width/2*.65;
  if(d>maxR){dx=dx/d*maxR;dy=dy/d*maxR;}
  joyInner.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
  joyDX=dx/maxR; joyDY=-dy/maxR;
}
function joyReset(){
  joyDX=0;joyDY=0;
  joyInner.style.transform='translate(-50%,-50%)';
}
document.getElementById('joystick-zone').addEventListener('touchstart',e=>{
  if(controlMode!=='joystick')return;
  e.preventDefault();joyMove(e.touches[0].clientX,e.touches[0].clientY);
},{passive:false});
document.getElementById('joystick-zone').addEventListener('touchmove',e=>{
  if(controlMode!=='joystick')return;
  e.preventDefault();joyMove(e.touches[0].clientX,e.touches[0].clientY);
},{passive:false});
['touchend','touchcancel'].forEach(ev=>document.getElementById('joystick-zone').addEventListener(ev,joyReset));
// Mouse fallback
let mj=false;
joyOuter.addEventListener('mousedown',e=>{if(controlMode!=='joystick')return;mj=true;joyMove(e.clientX,e.clientY);});
document.addEventListener('mousemove',e=>{if(mj&&controlMode==='joystick')joyMove(e.clientX,e.clientY);});
document.addEventListener('mouseup',()=>{if(mj){mj=false;joyReset();}});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gameState='MENU',score=0;
let spawnTimer=0,isInvincible=false,obstacles=[];
let bugFrame=0,bugFrameTimer=0,lastScore=0;
let playerCoins=0, sessionCoins=0, coinObjects=[], coinSpawnTimer=0;
let selectedCharacter='bug', unlockedChars=['bug'];
let noHandTimer=0;           // counts frames with no hand detected
const NO_HAND_PAUSE_FRAMES=90; // ~1.5s at 60fps before pausing

// Dynamic difficulty purely from score ‚Äî ramps continuously
function getDifficulty(){
  const pts=Math.floor(score/10);
  const base=diffMode==='hard'?2.0:1.0;
  // Every 50 points ‚Üí +0.18 speed, cap at 6√ó
  return Math.min(6, base+(pts/50)*0.18);
}
function getSpeedLevel(){
  const d=getDifficulty();
  if(d<1.4)return 1;
  if(d<2.0)return 2;
  if(d<2.8)return 3;
  if(d<3.8)return 4;
  if(d<5.0)return 5;
  return 6;
}

function spawnObstacle(){
  const diff=getDifficulty();
  const type=Math.floor(Math.random()*5);
  const ob={mesh:new THREE.Sprite(new THREE.SpriteMaterial({transparent:true})),type};
  ob.mesh.position.y=22+Math.random()*5;
  ob.mesh.position.x=(Math.random()-.5)*28;

  if(type===0||type===4){
    const gr=Math.random()>.5;
    ob.mesh.material.map=gr?texJetR:texJetL;ob.mesh.scale.set(5,2.5,1);
    ob.speedX=(gr?1:-1)*(0.15+Math.random()*.1)*diff;
    ob.speedY=0.08*diff;ob.mesh.position.x=gr?-18:18;
  }else if(type===1){
    ob.mesh.material.map=balTexes[Math.floor(Math.random()*3)];ob.mesh.scale.set(3.2,4,1);
    ob.speedX=(Math.random()-.5)*.05;ob.speedY=0.06*diff;
  }else if(type===2){
    ob.mesh.material.map=texBirdA;ob.mesh.scale.set(3.2,2.2,1);
    ob.speedX=(Math.random()>.5?1:-1)*(0.1+Math.random()*.08)*diff;
    ob.speedY=0.1*diff;
    if(ob.speedX<0)ob.mesh.scale.x=-ob.mesh.scale.x;
  }else{
    ob.mesh.material.map=texStorm;ob.mesh.scale.set(4,3.5,1);
    ob.speedX=(Math.random()-.5)*.04;ob.speedY=0.07*diff;
  }
  scene.add(ob.mesh);obstacles.push(ob);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function update(){
  if(gameState!=='PLAYING')return;
  const diff=getDifficulty();

  // Bug wing animation
  if(++bugFrameTimer>8){
    bugFrame=bugFrame===0?1:0;bugFrameTimer=0;
    if(selectedCharacter==='dragonfly'){player.material.map=bugFrame===0?texDflyA:texDflyB;}
    else if(selectedCharacter==='butterfly'){player.material.map=bugFrame===0?texBtflyA:texBtflyB;}
    else{player.material.map=bugFrame===0?texBugA:texBugB;}
  }

  // ‚îÄ‚îÄ Player control
  if(controlMode==='joystick'){
    const moving=Math.abs(joyDX)>.05||Math.abs(joyDY)>.05;
    const spd=0.2*(1+diff*.08);
    if(moving){
      let nx=player.position.x+joyDX*spd;
      if(nx>16)nx=-16; else if(nx<-16)nx=16; // wrap left‚Üîright
      player.position.x=nx;
      player.position.y=Math.max(-15,Math.min(14,player.position.y+joyDY*spd));
      document.getElementById('lift-warning').style.display='none';
    }else{
      player.position.y-=0.1; // gravity when joystick centered
    }
    tetherLine.visible=false;
  }else{
    // Hand tracking
    if(hasFinger){
      noHandTimer=0; // reset when hand is visible
      player.position.x+=(targetPos.x-player.position.x)*.14;
      player.position.y+=(targetPos.y-player.position.y)*.14;
      // Wrap horizontally, clamp vertically
      if(player.position.x>16)player.position.x=-16;
      else if(player.position.x<-16)player.position.x=16;
      player.position.y=Math.max(-15,Math.min(14,player.position.y));
      tetherLine.visible=true;
      tetherLine.geometry.setFromPoints([player.position.clone(),new THREE.Vector3(targetPos.x,targetPos.y,5)]);
    }else{
      noHandTimer++;
      // Show warning immediately
      document.getElementById('lift-warning').style.display='block';
      if(noHandTimer>=NO_HAND_PAUSE_FRAMES){
        // Pause game and show camera-lost popup instead of letting bug fall/die
        showCamLostPopup();
        return;
      }
      // Still fall slowly before popup kicks in
      player.position.y-=0.18;tetherLine.visible=false;
    }
  }

  // ‚îÄ‚îÄ BG clouds (scroll faster as diff goes up)
  bgClouds.forEach(c=>{
    c.mesh.position.y-=c.speed*(1+diff*.12);
    if(c.mesh.position.y<-25){c.mesh.position.y=25;c.mesh.position.x=(Math.random()-.5)*60;}
  });

  // ‚îÄ‚îÄ Spawn ‚Äî interval shrinks with score
  spawnTimer--;
  const spawnInt=Math.max(14,55-Math.floor(score/150)*3);
  if(spawnTimer<=0){spawnObstacle();spawnTimer=spawnInt;}

  // ‚îÄ‚îÄ Obstacles
  const now=Date.now();
  for(let i=obstacles.length-1;i>=0;i--){
    const o=obstacles[i];
    // scrollY also scales continuously with diff
    o.mesh.position.y-=o.speedY*(1+(diff-1)*.25);
    o.mesh.position.x+=o.speedX;
    if(o.type===2)o.mesh.material.map=Math.floor(now/120)%2===0?texBirdA:texBirdB;
    if(o.type===0||o.type===4){
      if(o.mesh.position.x>24||o.mesh.position.x<-24){scene.remove(o.mesh);obstacles.splice(i,1);continue;}
    }
    const dist=player.position.distanceTo(o.mesh.position);
    const hitR=o.type===1?3.5:(o.type===0||o.type===4?2.5:2.8);
    if(!isInvincible&&dist<hitR){
      playSfx('crash');spawnParticles(player.position.x,player.position.y,0xFF2020);
      gameOver();return;
    }
    if(o.mesh.position.y<-23||Math.abs(o.mesh.position.x)>33){scene.remove(o.mesh);obstacles.splice(i,1);}
  }

  // ‚îÄ‚îÄ Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.mesh.position.x+=p.vx;p.mesh.position.y+=p.vy;p.vy-=.005;
    p.life-=.04;p.mesh.material.opacity=p.life;
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }

  // ‚îÄ‚îÄ Coin spawn
  coinSpawnTimer--;
  if(coinSpawnTimer<=0){
    const coinMesh=new THREE.Sprite(new THREE.SpriteMaterial({map:texCoin,transparent:true}));
    coinMesh.scale.set(1.4,1.4,1);
    coinMesh.position.set((Math.random()-.5)*24, 24+Math.random()*5, 0);
    scene.add(coinMesh);
    coinObjects.push({mesh:coinMesh});
    coinSpawnTimer=Math.max(40,90-Math.floor(score/200)*5);
  }

  // ‚îÄ‚îÄ Coin movement and collection
  for(let i=coinObjects.length-1;i>=0;i--){
    const co=coinObjects[i];
    co.mesh.position.y-=0.06*(1+(getDifficulty()-1)*.2);
    co.mesh.rotation.z+=0.06;
    const cd=player.position.distanceTo(co.mesh.position);
    if(cd<2.2){
      // collected!
      scene.remove(co.mesh);coinObjects.splice(i,1);
      sessionCoins++;playerCoins++;
      document.getElementById('coin-display').innerText=`ü™ô ${sessionCoins}`;
      // save coins async
      if(typeof window.fbSaveCoins==='function') window.fbSaveCoins(playerCoins);
      // popup
      const pop=document.getElementById('coin-popup');
      pop.style.display='block';
      clearTimeout(pop._t);
      pop._t=setTimeout(()=>pop.style.display='none',700);
    } else if(co.mesh.position.y<-24){
      scene.remove(co.mesh);coinObjects.splice(i,1);
    }
  }

  // ‚îÄ‚îÄ Floor death
  if(player.position.y<-16){playSfx('crash');gameOver();return;}

  // ‚îÄ‚îÄ Score & HUD
  score++;
  const pts=Math.floor(score/10);
  if(score>0&&score%120===0){
    playSfx('score');spawnParticles(player.position.x,player.position.y+1,0xFFD700);
  }
  document.getElementById('score-display').innerText=`‚≠ê ${pts}`;

  // Speed bar
  const pct=Math.min(100,((diff-1)/(6-1))*100);
  const fill=document.getElementById('speed-bar-fill');
  fill.style.width=pct+'%';
  fill.style.background=pct<40?'linear-gradient(90deg,#00CFFF,#00FF88)':pct<70?'linear-gradient(90deg,#FFD700,#FF8C00)':'linear-gradient(90deg,#FF4444,#FF00FF)';
  document.getElementById('speed-display').innerText=`üöÄ LVL ${getSpeedLevel()}`;
}

function showCamLostPopup(){
  gameState='PAUSED';
  document.getElementById('lift-warning').style.display='none';
  tetherLine.visible=false;
  handDot.style.display='none';
  document.getElementById('cam-lost-popup').style.display='flex';
}

function resumeFromCamLost(){
  document.getElementById('cam-lost-popup').style.display='none';
  noHandTimer=0;
  gameState='PLAYING';
}

function gameOver(){
  gameState='GAMEOVER';
  lastScore=Math.floor(score/10);
  // remove leftover coins
  coinObjects.forEach(c=>scene.remove(c.mesh));coinObjects=[];
  document.getElementById('game-over-screen').classList.remove('hidden');
  document.getElementById('final-score-go').innerText=`SCORE: ${lastScore}`;
  tetherLine.visible=false;
  document.getElementById('lift-warning').style.display='none';
  handDot.style.display='none';
  // Pre-fill name from Google
  if(window._currentUser?.displayName){
    document.getElementById('player-name-input').value=
      window._currentUser.displayName.split(' ')[0].toUpperCase().slice(0,12);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadLeaderboard(){
  const list=document.getElementById('leaderboard-list');
  list.innerHTML='<div id="lb-loading">‚è≥ Loading‚Ä¶</div>';
  let rows=[];
  if(typeof window.fbGetLeaderboard==='function')rows=await window.fbGetLeaderboard();
  if(!rows||rows.length===0){
    list.innerHTML='<div id="lb-loading" style="color:#888">No scores yet ‚Äî be the first! üèÜ</div>';return;
  }
  const medals=['ü•á','ü•à','ü•â'];
  list.innerHTML=rows.map((r,i)=>`
    <div class="lb-row ${i===0?'top1':i===1?'top2':i===2?'top3':''}">
      <span class="lb-rank">${medals[i]||`#${i+1}`}</span>
      <span class="lb-name">${(r.name||'???').toUpperCase()}</span>
      <span class="lb-score">‚≠ê ${r.score}</span>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHOP_CHARS = [
  { id:'bug',       name:'Ladybug',    desc:'The original flyer',  price:0,    draw:(c,w,h)=>drawBug(c,w,h,0.5) },
  { id:'dragonfly', name:'Dragonfly',  desc:'Sleek & fast wings',  price:150,  draw:(c,w,h)=>drawDragonfly(c,w,h,0.5) },
  { id:'butterfly', name:'Butterfly',  desc:'Colorful & graceful', price:300,  draw:(c,w,h)=>drawButterfly(c,w,h,0.5) },
];

function renderShop(){
  document.getElementById('shop-coin-count').innerText=playerCoins;
  const grid=document.getElementById('shop-grid');
  grid.innerHTML='';
  SHOP_CHARS.forEach(ch=>{
    const owned=unlockedChars.includes(ch.id);
    const isSel=selectedCharacter===ch.id;
    const card=document.createElement('div');
    card.className='shop-card'+(owned?' owned':'')+(isSel?' selected-char':'');
    const canvas=document.createElement('canvas');
    canvas.width=56;canvas.height=56;canvas.className='shop-char-canvas';
    ch.draw(canvas.getContext('2d'),56,56);
    const info=document.createElement('div');info.className='shop-char-info';
    info.innerHTML=`<div class="shop-char-name">${ch.name}</div><div class="shop-char-desc">${ch.desc}</div>${ch.price>0&&!owned?`<div class="shop-char-price">ü™ô ${ch.price} coins</div>`:''}`;
    const btn=document.createElement('button');
    if(isSel){
      btn.textContent='‚úì Selected';btn.className='btn-buy owned';btn.disabled=true;
    }else if(owned){
      btn.textContent='Select';btn.className='btn-buy select-btn';
      btn.addEventListener('click',()=>{selectedCharacter=ch.id;renderShop();updateMenuPreview();});
    }else{
      btn.textContent=ch.price>0?`Buy ü™ô${ch.price}`:'Free';
      btn.className='btn-buy';
      if(ch.price===0){
        btn.addEventListener('click',()=>{unlockedChars.push(ch.id);if(typeof window.fbSaveUnlocked==='function')window.fbSaveUnlocked(unlockedChars);renderShop();});
      }else{
        btn.addEventListener('click',()=>{
          if(playerCoins>=ch.price){
            playerCoins-=ch.price;
            unlockedChars.push(ch.id);
            selectedCharacter=ch.id;
            if(typeof window.fbSaveCoins==='function')window.fbSaveCoins(playerCoins);
            if(typeof window.fbSaveUnlocked==='function')window.fbSaveUnlocked(unlockedChars);
            renderShop();updateMenuPreview();
          }else{
            alert(`Not enough coins! You need ${ch.price} ü™ô but have ${playerCoins}.`);
          }
        });
      }
    }
    card.appendChild(canvas);card.appendChild(info);card.appendChild(btn);
    grid.appendChild(card);
  });
}

function updateMenuPreview(){
  const c=document.getElementById('menu-bug-canvas').getContext('2d');
  c.clearRect(0,0,70,70);
  if(selectedCharacter==='dragonfly') drawDragonfly(c,70,70,0.5);
  else if(selectedCharacter==='butterfly') drawButterfly(c,70,70,0.5);
  else drawBug(c,70,70,0.5);
}

document.getElementById('btn-open-shop').addEventListener('click',()=>{
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('shop-screen').classList.remove('hidden');
  renderShop();
});
document.getElementById('btn-shop-back').addEventListener('click',()=>{
  document.getElementById('shop-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE AUTH UI (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._currentUser = null;

// Wait for the window to fully load so Firebase is ready
window.addEventListener('load', () => {
    if (typeof window.fbOnAuth === 'function') {
        window.fbOnAuth(user => {
            window._currentUser = user;
            const av = document.getElementById('user-avatar');
            const un = document.getElementById('user-name');
            const so = document.getElementById('btn-signout');
            const la = document.getElementById('login-area');
            
            if (user) {
                // User is logged in
                av.src = user.photoURL || '';
                av.style.display = 'block';
                un.innerText = user.displayName?.split(' ')[0] || '';
                un.style.display = 'block';
                so.style.display = 'block';
                la.style.display = 'none';
                // Load coins and unlocked chars
                if(typeof window.fbGetCoins==='function') window.fbGetCoins().then(c=>{playerCoins=c||0;});
                if(typeof window.fbGetUnlocked==='function') window.fbGetUnlocked().then(u=>{if(u&&u.length)unlockedChars=[...new Set(['bug',...u])];});
            } else {
                // User is signed out
                av.style.display = 'none';
                un.style.display = 'none';
                so.style.display = 'none';
                la.style.display = 'block';
            }
        });
    } else {
        console.error("Firebase not loaded yet. Check your internet or config.");
    }
});

document.getElementById('btn-google-login').addEventListener('click',async(e)=>{
  e.preventDefault();
  if(typeof window.fbSignInGoogle==='function')await window.fbSignInGoogle();
  else alert("Firebase is still loading. Please wait a second and try again.");
});
document.getElementById('btn-signout').addEventListener('click',async()=>{
  if(typeof window.fbSignOut==='function')await window.fbSignOut();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startCountdown(){
  
  if(!window._currentUser) {
    alert("Please sign in with Google to play!");
    return;
  }
  // ... rest of the countdown code


  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('game-over-screen').classList.add('hidden');
  const cs=document.getElementById('countdown-screen');cs.classList.remove('hidden');
  let c=3;document.getElementById('countdown-text').innerText=c;
  const t=setInterval(()=>{
    if(--c>0)document.getElementById('countdown-text').innerText=c;
    else{clearInterval(t);cs.classList.add('hidden');startGame();}
  },900);
}

function startGame(){
  gameState='PLAYING';score=0;spawnTimer=0;sessionCoins=0;coinSpawnTimer=60;noHandTimer=0;
  player.position.set(0,0,0);player.material.opacity=1;isInvincible=false;
  obstacles.forEach(o=>scene.remove(o.mesh));obstacles=[];
  particles.forEach(p=>scene.remove(p.mesh));particles.length=0;
  // remove leftover coins
  coinObjects.forEach(c=>scene.remove(c.mesh));coinObjects=[];
  document.getElementById('lift-warning').style.display='none';
  document.getElementById('coin-display').innerText='ü™ô 0';
  // apply character sprite
  if(selectedCharacter==='dragonfly'){player.material.map=texDflyA;}
  else if(selectedCharacter==='butterfly'){player.material.map=texBtflyA;}
  else{player.material.map=texBugA;}
  applyControlUI();
}

document.getElementById('btn-cam-lost-resume').addEventListener('click', resumeFromCamLost);
document.getElementById('btn-cam-lost-joystick').addEventListener('click', ()=>{
  setControl('joystick');
  resumeFromCamLost();
});

document.getElementById('btn-play').addEventListener('click',startCountdown);
document.getElementById('btn-restart').addEventListener('click',()=>{
  document.getElementById('game-over-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
});
document.getElementById('btn-open-scores').addEventListener('click',async()=>{
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('scores-screen').classList.remove('hidden');
  await loadLeaderboard();
});
document.getElementById('btn-scores-back').addEventListener('click',()=>{
  document.getElementById('scores-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
});
document.getElementById('btn-open-settings').addEventListener('click',()=>{
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('settings-screen').classList.remove('hidden');
});
document.getElementById('btn-settings-back').addEventListener('click',()=>{
  document.getElementById('settings-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
});
document.getElementById('btn-submit-score').addEventListener('click',async()=>{
  const ni=document.getElementById('player-name-input');
  const name=ni.value.trim()||window._currentUser?.displayName?.split(' ')[0]||'ANON';
  const btn=document.getElementById('btn-submit-score');
  btn.innerText='‚è≥ Saving‚Ä¶';btn.disabled=true;
  if(typeof window.fbSubmitScore==='function')await window.fbSubmitScore(name,lastScore);
  btn.innerText='‚úÖ Saved!';
  setTimeout(()=>{btn.innerText='üì§ SUBMIT SCORE';btn.disabled=false;},2000);
});
document.getElementById('btn-watch-ad').addEventListener('click',()=>{
  // üî¥ Plug in your ad SDK (Applixir, AdMob, Unity Ads‚Ä¶) here
  document.getElementById('game-over-screen').classList.add('hidden');
  startGame();isInvincible=true;player.material.opacity=.5;
  setTimeout(()=>{isInvincible=false;player.material.opacity=1;},4000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function animate(){requestAnimationFrame(animate);update();renderer.render(scene,camera);}
animate();
window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);
});

// (duplicate login/signout listeners removed ‚Äî handled above)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACK BUTTON INTERCEPTION (EXIT POPUP)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// 1. Push a state immediately on load so we have something to go "back" to
history.pushState(null, document.title, location.href);

// 2. Listen for the back button (popstate)
window.addEventListener('popstate', function (event) {
  // Prevent immediate exit by pushing state again
  history.pushState(null, document.title, location.href);
  
  // Pause game if playing
  if(gameState === 'PLAYING') {
    // Optional: You could add a 'PAUSED' state here if you wanted
  }

  // Show the custom modal
  document.getElementById('exit-modal').classList.remove('hidden');
});

// 3. Handle "NO" (Stay in game)
document.getElementById('btn-exit-no').addEventListener('click', () => {
  document.getElementById('exit-modal').classList.add('hidden');
});

// 4. Handle "YES" (Actually exit)
document.getElementById('btn-exit-yes').addEventListener('click', () => {
  // Try to close the window (works for PWAs/Popups)
  window.close();
  
  // If window.close() is blocked by browser security, redirect to Google or Home
  // This is a fallback to ensure the user actually leaves
  window.location.href = "https://www.hushly.fun";
});

</script>
</body>
</html>
